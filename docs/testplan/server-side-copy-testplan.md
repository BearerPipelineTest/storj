# Server Side Copy Testplan

&nbsp;

## Background
This testplan is going to cover Server Side Copy. We want it to be an atomic operation; it should have no decrypt/encrypt operations, it should only copy committed objects, it will avoid downloading and re-uploading and should be a fast operation.

&nbsp;

&nbsp;


| Test Scenario          | Test Cases                                                         | Description                                                                                                                                                                                                                                                             | Comments |
|------------------------|--------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| Other Services         | Test Impact on Audits                                              | While audits are running, it should be possible to server side copy with no negative impact on former services                                                                                                                                                          |          |
|                        | Test Impact on Graceful Exit                                       | While graceful exit is running, it should be possible to server side copy with no negative impact on former services                                                                                                                                                    |          |
|                        | Test Impact on Garbage Collection                                  | While garbage collection is running, it should be possible to server side copy with no negative impact on former services                                                                                                                                               |          |
|                        | Test Impact on Data Repair                                         | While data is being repaired, it should be possible to server side copy with no negative impact on former services as data repair should ignore segments with a set ancestor_stream_id                                                                                  |          |
|                        | Test Impact on Metainfo > Expired Deletion                         | While metainfo loop is going through expired deletion, it should be possible to server side copy with no negative impact on former services                                                                                                                             |          |
|                        | Test Impact on Accounting/Tally                                    | While accounting services are running, it should be possible to server side copy with no negative impact on former services                                                                                                                                             |          |
|                        | Test Expiration Dates                                              | For server side copy users are allowed to make new copies of pieces which allows users to change their expiration dates, so in this way users are able to change expiration date of the new object through server side copy                                             |          |
| DB- Table Segment      | Test Expiration Date                                               | If a user uses Server-side copy, then the source object and the destination object must have the same experation date                                                                                                                                                   |          |
|                        | Test ancestor_stream_id negative                                   | If a segment hasn't been copied, then it is empty under ancestor_stream_id in the db                                                                                                                                                                                    |          |
|                        | Test ancestor_stream_id positive                                   | If a segment has been copied, then for the copied segment it contains the ancestor_stream_id which is the stream_id for the original segment                                                                                                                            |          |
|                        | Test reference_counter integer                                     | there is a reference_counter integer which counts the number of segments having stream_id as ancestor_stream_id, so If a new segment has been server side copied then the integer should reflect that (+1)                                                              |          |
|                        | Test Original Segment - Deletion & stream_id check                 | If a new uploaded segment gets copied and then the original gets deleted, then that copied segment should become the original segment (no ancestor_stream_id anymore only stream_id)                                                                                    |          |
|                        | Test Original Segment - Deletion & reference_counter check         | If a new uploaded segment gets copied and then the original gets deleted, then the reference counter should get set back to 0                                                                                                                                           |          |
|                        | Test Two Copies - ancestor_stream_id                               | If a new uploaded segment gets copied and then another copy is made from the original, then both copies should have the same ancestor_stream_id                                                                                                                         |          |
|                        | Test Two Copies - reference_counter                                | If a new uploaded segment gets copied and then another copy is made from the original, then in the reference_counter for the new uploaded segment the integer should reflect that based on the number of new copies (+2)                                                |          |
|                        | Test Two Copies - Original Segment Deletion (stream_id)            | If a new uploaded segment gets copied and another copy is made from the original and then the original gets deleted, the first copied segment with the new ancestor stream id becomes the original segment                                                              |          |
|                        | Test Two Copies- Original Segment Deletion (reference_counter)     | If a new uploaded segment gets copied and another copy is made from the original and then the original gets deleted, the reference counter of the first copied segment gets increased by one (+1)                                                                       |          |
|                        | Test Copy of Copy- ancestor_stream_id                              | If a new uploaded segment gets copied and another copy is made from that copy, then the first copy should have its ancestor_stream_id set as the original segments stream_id while the second copy should have its ancestor_stream_id set as the first copy's stream_id |          |
|                        | Test Copy of Copy- reference_counter                               | If a new uploaded segment gets copied and another copy is made from that copy, then in the reference_counter for the new uploaded segment and the first copy, the integer should be one (+1)                                                                            |          |
|                        | Test Copy of Copy- Original Segment Deletion (stream_id)           | When a new uploaded segment gets copied and another copy is made from that copy, after deleting the original, then the first copy should become the original segment while the second copy should have its ancestor_stream_id set as the first copy's stream_id         |          |
|                        | Test Copy of Copy- First Copy Segment Deletion (stream_id)         | When a new uploaded segment gets copied and another copy is made from that copy, after deleting the first copy, then the second copy should become the first and have its ancestor_stream_id set as the original's stream_id                                            |          |
|                        | Test Copy of Copy- Original Segment Deletion (reference_counter)   | If a new uploaded segment gets copied, another copy is made from that copy and then the original gets deleted, the reference counter of the first copied segment should still be one (+1) and the second copied segment should still be zero (0)                        |          |
|                        | Test Copy of Copy- First Copy Segment Deletion (reference_counter) | If a new uploaded segment gets copied, another copy is made from that copy and then the first copy gets deleted, the reference counter of the other copied segment should be zero (0) and the original should be one (1)                                                |          |
| Segment Size & Numbers | Test Bandwidth & Storage- inline segment                           | If a user uploads an inline segment and then server side copies from the source object to the destination object, then bandwidth and storage should stay the same before the operation                                                                                  |          |
|                        | Test File Size- inline segment                                     | If a user uploads an inline segment and then server side copies from the source object to the destination object, then the destination object should contain total file size as the original source object                                                              |          |
|                        | Test Object Deleted During Copy- inline segment                    | If a user uploads an inline segment and then server side copies from the source object to the destination object all while deleting the original source object, then an error is thrown                                                                                 |          |
|                        | Test Object Deleted After Copy- inline segment                     | If a user uploads an inline segment, server side copies it from the source object to the destination object and then deletes the original source object, then an error is not shown                                                                                     |          |
|                        | Test Bandwidth & Storage- remote segment                           | If a user uploads an remote segment and then server side copies from the source object to the destination object, then bandwidth and storage should stay the same before the operation                                                                                  |          |
|                        | Test File Size- remote segment                                     | If a user uploads an remote segment and then server side copies from the source object to the destination object, then the destination object should be the same size as the original source object                                                                     |          |
|                        | Test Object Deleted During Copy- remote segment                    | If a user uploads an remote segment and then server side copies from the source object to the destination object all while deleting the original source object, then an error is thrown                                                                                 |          |
|                        | Test Object Deleted After Copy- remote segment                     | If a user uploads an remote segment, server side copies it from the source object to the destination object and then deletes the original source object, then an error is not shown                                                                                     |          |
|                        | Test Copy 10000 Or Less Segments                                   | If a user uploads an object with 10000 or less segments and server side copies it from the source object to the destination object, it should be possible                                                                                                               |          |
|                        | Test Copy 10001 Or More Segments                                   | If a user uploads an object with 10001 segments or more and server side copies it from the source object to the destination object, it should not be possible and should return an error                                                                                |          |
|                        | Test Copy Objects More than 5GB                                    | If objects are between 5GB and 5TB (max object size), then upload-part-copy api must be used for server side copy                                                                                                                                                       |          |
|                        | Test Copy Objects Less than 5GB                                    | If objects are less than 5GB in size, then server side copy must be an atomic operation                                                                                                                                                                                 |          |
|                        | Test Copy 0 bytes object                                           | User should copy 0 bytes object without any error                                                                                                                                                                                                                       |          |
|                        | Test Copy inline segment                                           | User should copy inline segment without any errors                                                                                                                                                                                                                      |          |
|                        | Test Copy remote segment                                           | User should copy inline segment without any errors                                                                                                                                                                                                                      |          |
|                        | Test Start server-side copying process and drop connection         | File should be copied even when connection is dropped                                                                                                                                                                                                                   |          |
